# Projet Pok√©dex 2.0

![pok√©dex](../images/cours/bts-2/90/pokedex-01.png)

Ce TP propose de r√©aliser un Pok√©dex en utilisant le framework Qt. 

Un Pok√©dex est un appareil qui accompagne tout bon dresseur de Pok√©mon(1) et qui liste les Pok√©mon et leurs informations.
{ .annotate }

1.  :material-pokeball: Pok√©mon est invariable et s'√©crit avec un accent m√™me en anglais.

Notre application √©mulera cet appareil et s‚Äôappuiera sur les webservices du site internet [pokeapi.co](https://pokeapi.co/) pour r√©cup√©rer informations sur les Pok√©mon et leurs images.

## Travaux pr√©paratoires

Pok√©API propose des webservices [REST]("REpresentational State Transfer") permettant de r√©cup√©rer des informations sur les Pok√©mon.

Pour les utiliser, nous devons ma√Ætriser deux techniques avec Qt :

+   [ ] Envoyer une requ√™te HTTP GET et g√©rer la r√©ponse

+   [ ] Manipuler des informations au format [JSON]("JavaScript Object Notation)

### Envoyer une requ√™te HTTP GET et g√©rer la r√©ponse

1.  Ajouter le module Network au projet Qt en ajoutant la ligne suivante au d√©but du fichier `.pro`¬†:

    ```cpp
    QT += network
    ```

2.  Pour g√©rer les requ√™tes HTTP, on utilisera un objet **unique** `QNetworkAccessManager` ajout√© en attribut de la fen√™tre.

    Cet objet contient une [m√©thode](https://doc.qt.io/qt-5/qnetworkaccessmanager.html#get) `QNetworkReply * get(QNetworkRequest(QUrl("url √† requ√™ter")))` qui permet d‚Äôenvoyer une requ√™te HTTP de type GET.

    On sauvera l'adresse de l'objet `QNetworkReply` renvoy√©e par la m√©thode dans un attribut `QNetworkReply *` de la fen√™tre.

    Ajouter les attributs suivants √† la classe `MainWindow` :

    ```cpp
    QNetworkAccessManager * qnam;
    QNetworkReply * qnr;
    ```

    Dans le constructeur de la `MainWindow`, affecter un nouvel objet `QNetworkAccessManager` √† `qnam` et `nullptr` √† `qnr` (l'objet `qnr` sera renouvel√© √† chaque nouvelle requ√™te).

    D√©truire `qnam` et `qnr` lorsque le programme s'arr√™te.

3.  Ajouter un bouton dans la fen√™tre qui permettra de d√©clencher l'envoi de la requ√™te.

4.  Connecter le clic du bouton √† un nouveau slot `launchHTTPRequest`.

    Dans la d√©finition du slot `launchHTTPRequest` appeler la m√©thode `get()` de `qnam` sur l'url `https://pokeapi.co/api/v2/pokemon/25` et stocker le r√©sultat dans `qnr`.
    
5.  La requ√™te HTTP est lanc√©e de mani√®re asynchrone(1). 
    { .annotate }

    1.  :material-pokeball: La requ√™te est lanc√©e en arri√®re-plan, dans un autre thread, elle ne bloque pas l'ex√©cution du thread courant et donc l'application.

    Quand la r√©ponse du serveur (quelle qu'elle soit) est compl√©tement re√ßue, l'objet `QNetworkReply` √©met un signal `finished()`.

    Connecter un nouveau slot `manageHTTPAnswer` √† ce signal juste apr√®s l'appel de la m√©thode `get()` de `qnam`.

    En effet, un nouvel objet `QNetworkReply` est cr√©√© √† chaque appel de `get`, `qnr` change donc d'adresse et il faut donc cr√©er une nouvelle connexion.

6.  Dans la d√©finition du slot `manageHTTPAnswer`, afficher dans la console le contenu du corps de la r√©ponse en appelant la m√©thode `readAll()` de `qnr`.

7.  Tester.

    Si tout se passe bien, la console doit √™tre remplie 

    ```json
    {"abilities":[{"ability":{"name":"static","url":"https://pokeapi.co/api/v2/ability/9/"},"is_hidden":false,"slot":1},{"ability":{"name":"lightning-rod","url":"https://pokeapi.co/api/v2/ability/31/"},"is_hidden":true,"slot":3}],"base_experience":112,"cries":{"latest":"https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/25.ogg","legacy":"https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/legacy/25.ogg"},...
    ```

Am√©liorer le script :

+   [ ] D√©connecter l'objet point√© par `qnr` de `manageHTTPAnswer` et le supprimer avant l'appel de la m√©thode `get()`.

+   [ ] G√©rer les erreurs HTTP en connectant le signal QNetworkReply::errorOccurred √† un nouveau slot `manageHTTPErrors`.

### Manipuler des informations au format JSON

1.  Ajouter un bouton dans la fen√™tre qui permettra de d√©clencher la lecture du JSON.

2.  Connecter le clic du bouton √† un nouveau slot `readJSON`.

    Dans la d√©finition du slot `readJSON`, nous allons cr√©er un objet `QJsonObject` √† partir du contenu JSON suivant :

    ```json
    {
        "FirstName": "John",
        "LastName": "Doe",
        "Age": 43,
        "Address": {
            "Street": "Downing Street 10",
            "City": "London",
            "Country": "Great Britain"
        },
        "Phone numbers": [
            "+44 1234567",
            "+44 2345678"
        ]
    }
    ```

    Le code permettant de r√©aliser cela est le suivant :

    ```cpp
    QByteArray data("Donn√©es au format JSON");
    QJsonDocument doc = QJsonDocument::fromJson(data);
    QJsonObject json = doc.object();
    ```

    Utiliser Notepad++ pour : 
        
    +   mettre les donn√©es JSON sur une ligne, 
    
    +   supprimer les doubles espaces,
    
    +   √©chapper les guillemets doubles.
    
    Int√©grer le r√©sultat au code ci-dessus dans le slot `readJSON`.

3.  Pour acc√©der √† une valeur, la m√©thode la plus **s√ªre** est de r√©aliser la petite gymnastique suivante :

    1. v√©rifier que le champ/attribut existe,

    2. v√©rifier qu'il est bien du type attendu (int, string, array, object...),

    3. r√©cup√©rer sa valeur.

    Et r√©p√©ter cela pour chaque niveau "hi√©rarchique"... üò•

    Afficher le pr√©nom √† l'aide du code suivant :

    ```cpp
    if (json.contains("FirstName") && json["FirstName"].isString()) {
        qDebug() << json["FirstName"].toString();
    }
    ```

4. Tester.

5. Afficher dans la console "John Doe (43), London" √† l'aide des informations extraites des donn√©es JSON.

Am√©liorer le script :

+   [ ] Cr√©er une classe d√©riv√©e de QJsonObject et surd√©finir la m√©thode `value()` pour qu'elle l√®ve une exception en cas d'erreur (et s'√©viter la petite gymnastique üòÖ).

### Combiner les deux techniques

En combinant les deux techniques, cr√©er une mini-application qui nous affiche le nom en fran√ßais d'un Pok√©mon dont on lui soumet le num√©ro.

![Pok√©dex v0](../images/cours/bts-2/90/pokedex-02.png)